name: Java CI/CD with Docker

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:
    name: ğŸ”§ Build and Test
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ§ª Compile Java
        run: |
          mkdir -p bin
          javac -d bin src/*.java

      - name: ğŸš€ Run Automated API Tests
        run: |
          # Rendre le script de test exÃ©cutable
          chmod +x test-api.sh
          
          # DÃ©marrer le serveur en arriÃ¨re-plan
          java -cp bin Main &
          SERVER_PID=$!
          
          # Attendre que le serveur dÃ©marre
          echo "â³ Attente du dÃ©marrage du serveur..."
          for i in {1..30}; do
            if curl -s --max-time 2 http://localhost:8081/tickets/isEmpty > /dev/null 2>&1; then
              echo "âœ… Serveur dÃ©marrÃ© avec succÃ¨s"
              break
            fi
            sleep 2
            echo "   Tentative $i/30..."
          done
          
          # Lancer les tests automatiques
          echo "ğŸ§ª ExÃ©cution des tests automatiques..."
          java -cp bin ApiTest
          TEST_EXIT_CODE=$?
          
          # ArrÃªter le serveur
          echo "ğŸ›‘ ArrÃªt du serveur..."
          kill $SERVER_PID 2>/dev/null || true
          
          # VÃ©rifier si les tests ont rÃ©ussi
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âŒ Les tests ont Ã©chouÃ©"
            exit 1
          fi
          
          echo "âœ… Tous les tests sont passÃ©s avec succÃ¨s!"

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "# ğŸ“‹ Rapport de Tests API" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date)" >> test-report.md
          echo "**Commit:** ${{ github.sha }}" >> test-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> test-report.md
          echo "" >> test-report.md
          echo "## ğŸ§ª RÃ©sultats des Tests" >> test-report.md
          echo "" >> test-report.md
          
          # Relancer les tests pour capturer la sortie
          java -cp bin Main &
          SERVER_PID=$!
          sleep 5
          
          # Capturer les rÃ©sultats de test dans un fichier
          java -cp bin ApiTest > test-results.txt 2>&1 || true
          
          # Ajouter les rÃ©sultats au rapport
          echo '```' >> test-report.md
          cat test-results.txt >> test-report.md
          echo '```' >> test-report.md
          
          # ArrÃªter le serveur
          kill $SERVER_PID 2>/dev/null || true
          
          echo "ğŸ“„ Rapport de test gÃ©nÃ©rÃ©"

      - name: ğŸ“ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            test-report.md
            test-results.txt

      - name: ğŸ§ª Run server in background (test)
        run: |
          java -cp bin Main &
          sleep 5
          curl http://localhost:8081/

      - name: ğŸ³ Build Docker Image API
        run: docker build -t rest-api-java .

    

  

      
      
