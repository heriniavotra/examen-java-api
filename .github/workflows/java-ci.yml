name: Java CI/CD with Docker

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:
    name: ğŸ”§ Build and Test
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ§ª Compile Java
        run: |
          mkdir -p bin
          javac -d bin src/*.java

      - name: ğŸš€ Run Automated API Tests
        run: |
          # Rendre le script de test exÃ©cutable
          chmod +x test-api.sh
          
          # DÃ©marrer le serveur en arriÃ¨re-plan
          echo "ğŸš€ DÃ©marrage du serveur API..."
          java -cp bin Main &
          SERVER_PID=$!
          
          # Fonction pour nettoyer en cas d'erreur
          cleanup() {
            echo "ğŸ§¹ Nettoyage des processus..."
            kill $SERVER_PID 2>/dev/null || true
            sleep 2
            # Forcer l'arrÃªt si nÃ©cessaire
            pkill -f "java.*Main" 2>/dev/null || true
          }
          
          # Trap pour nettoyer en cas d'interruption
          trap cleanup EXIT
          
          # Attendre que le serveur dÃ©marre
          echo "â³ Attente du dÃ©marrage du serveur..."
          STARTUP_SUCCESS=false
          for i in {1..30}; do
            if curl -s --max-time 2 http://localhost:8081/tickets/isEmpty > /dev/null 2>&1; then
              echo "âœ… Serveur dÃ©marrÃ© avec succÃ¨s (tentative $i/30)"
              STARTUP_SUCCESS=true
              break
            fi
            sleep 2
            echo "   Tentative $i/30..."
          done
          
          if [ "$STARTUP_SUCCESS" = false ]; then
            echo "âŒ Le serveur n'a pas rÃ©ussi Ã  dÃ©marrer dans les temps"
            exit 1
          fi
          
          # Lancer les tests automatiques
          echo "ğŸ§ª ExÃ©cution des tests automatiques..."
          java -cp bin ApiTest
          TEST_EXIT_CODE=$?
          
          # Nettoyer (le trap s'occupera du cleanup)
          echo "ğŸ›‘ ArrÃªt du serveur..."
          
          # VÃ©rifier si les tests ont rÃ©ussi
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âŒ Les tests ont Ã©chouÃ© avec le code de sortie: $TEST_EXIT_CODE"
            exit 1
          fi
          
          echo "âœ… Tous les tests sont passÃ©s avec succÃ¨s!"

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "ğŸ“„ GÃ©nÃ©ration du rapport de test..."
          
          # CrÃ©er le rapport Markdown
          echo "# ğŸ“‹ Rapport de Tests API" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test-report.md
          echo "**Commit:** ${{ github.sha }}" >> test-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> test-report.md
          echo "**Workflow:** ${{ github.workflow }}" >> test-report.md
          echo "**Run Number:** ${{ github.run_number }}" >> test-report.md
          echo "" >> test-report.md
          echo "## ğŸ§ª RÃ©sultats des Tests" >> test-report.md
          echo "" >> test-report.md
          
          # VÃ©rifier si le serveur est encore en cours d'exÃ©cution
          SERVER_RUNNING=false
          if pgrep -f "java.*Main" > /dev/null; then
            SERVER_RUNNING=true
            echo "â„¹ï¸  Serveur dÃ©jÃ  en cours d'exÃ©cution"
          else
            echo "ğŸš€ DÃ©marrage du serveur pour le rapport..."
            java -cp bin Main &
            SERVER_PID=$!
            
            # Attendre que le serveur dÃ©marre
            for i in {1..15}; do
              if curl -s --max-time 2 http://localhost:8081/tickets/isEmpty > /dev/null 2>&1; then
                SERVER_RUNNING=true
                break
              fi
              sleep 2
            done
          fi
          
          if [ "$SERVER_RUNNING" = true ]; then
            # Capturer les rÃ©sultats de test
            echo "ğŸ§ª Capture des rÃ©sultats de test..."
            java -cp bin ApiTest > test-results.txt 2>&1 || true
            
            # Ajouter les rÃ©sultats au rapport
            echo '```' >> test-report.md
            cat test-results.txt >> test-report.md
            echo '```' >> test-report.md
            
            # ArrÃªter le serveur si nous l'avons dÃ©marrÃ©
            if [ -n "$SERVER_PID" ]; then
              kill $SERVER_PID 2>/dev/null || true
            fi
          else
            echo "âŒ Impossible de dÃ©marrer le serveur pour le rapport" >> test-report.md
            echo "Serveur indisponible pour gÃ©nÃ©rer le rapport dÃ©taillÃ©." > test-results.txt
          fi
          
          echo "ğŸ“„ Rapport de test gÃ©nÃ©rÃ© avec succÃ¨s"

      - name: ğŸ“ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-report.md
            test-results.txt

      - name: ğŸ§ª Verify Server Connectivity
        run: |
          echo "ğŸ” Test de connectivitÃ© basique du serveur..."
          
          # S'assurer qu'aucun serveur ne tourne dÃ©jÃ 
          pkill -f "java.*Main" 2>/dev/null || true
          sleep 2
          
          # DÃ©marrer le serveur pour un test rapide
          java -cp bin Main &
          SERVER_PID=$!
          
          # Attendre et tester la connectivitÃ©
          sleep 5
          
          if curl -s --max-time 5 http://localhost:8081/ > /dev/null; then
            echo "âœ… Serveur accessible via HTTP"
          else
            echo "âŒ Serveur non accessible"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # Nettoyer
          kill $SERVER_PID 2>/dev/null || true
          echo "ğŸ§¹ Test de connectivitÃ© terminÃ©"

      - name: ğŸ§¹ Cleanup Processes
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage final des processus..."
          # ArrÃªter tous les processus Java Main qui pourraient encore tourner
          pkill -f "java.*Main" 2>/dev/null || true
          sleep 2
          # VÃ©rifier qu'aucun processus ne reste
          if pgrep -f "java.*Main" > /dev/null; then
            echo "âš ï¸  Des processus Java sont encore en cours d'exÃ©cution"
            pkill -9 -f "java.*Main" 2>/dev/null || true
          else
            echo "âœ… Tous les processus ont Ã©tÃ© nettoyÃ©s"
          fi

      - name: ğŸ³ Build Docker Image API
        run: docker build -t rest-api-java .

    

  

      
      
